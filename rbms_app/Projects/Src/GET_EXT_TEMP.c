/*
 * <모듈 요약>
 * <모듈 상세 설명>
 */

#include "GET_EXT_TEMP.h"

/*== MACRO ===================================================================*/

#define TEMP_TBL_CNT 191
#define TEMP_IDX 0
#define TEMP_AD_IDX 1
/*== GLOBAL VARIABLE =========================================================*/

_EXT_TEMP FET_TEMP;
_EXT_TEMP BD_TEMP;

/*== STATIC VARIABLE =========================================================*/

static const float TEMP_TABLE[2][TEMP_TBL_CNT] =
{
    /* 온도 */
    {
        -40, -39, -38, -37, -36, -35, -34, -33, -32, -31, -30, -29, -28, -27, -26, -25, -24, -23, -22, -21,
        -20, -19, -18, -17, -16, -15, -14, -13, -12, -11, -10,  -9,  -8,  -7,  -6,  -5,  -4,  -3,  -2,  -1,
        0,   1,   2,   3,   4,   5,   6,   7,   8,   9, 10,  11,  12,  13,  14,  15,  16,  17,  18,  19,
        20,  21,  22,  23,  24,  25,  26,  27,  28,  29, 30,  31,  32,  33,  34,  35,  36,  37,  38,  39,
        40,  41,  42,  43,  44,  45,  46,  47,  48,  49, 50,  51,  52,  53,  54,  55,  56,  57,  58,  59,
        60,  61,  62,  63,  64,  65,  66,  67,  68,  69, 70,  71,  72,  73,  74,  75,  76,  77,  78,  79,
        80,  81,  82,  83,  84,  85,  86,  87,  88,  89, 90,  91,  92,  93,  94,  95,  96,  97,  98,  99,
        100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119,
        120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139,
        140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150
    },
    /* 전압 (V) */
    {
        3.135024786, 3.126315832, 3.117225170, 3.107748270, 3.097868443, 3.087590218, 3.076876163, 3.065741539, 3.054153204, 3.042127132,
        3.029641151, 3.016665220, 3.003237486, 2.989297628, 2.974870443, 2.959937334, 2.944492340, 2.928533077, 2.912047625, 2.895037413,
        2.877486467, 2.859406710, 2.840780020, 2.821621180, 2.801909208, 2.781661749, 2.760872364, 2.739537954, 2.717671156, 2.695272207,
        2.672337055, 2.648881197, 2.624918699, 2.600447178, 2.575473785, 2.550016880, 2.524095297, 2.497704983, 2.470854282, 2.443591118,
        2.415897608, 2.387818336, 2.359346628, 2.330495358, 2.301331520, 2.271834373, 2.242036581, 2.211968422, 2.181621313, 2.151054859,
        2.120290995, 2.089346170, 2.058184624, 2.026949883, 1.995548964, 1.964129806, 1.932577729, 1.901042819, 1.869446754, 1.837882161,
        1.806314111, 1.774834633, 1.743469715, 1.712163687, 1.681003690, 1.649999976, 1.619147897, 1.588488340, 1.558042049, 1.527816772,
        1.497833967, 1.468111873, 1.438674331, 1.409521580, 1.380681276, 1.352154970, 1.323964000, 1.296125889, 1.268630743, 1.241514087,
        1.214757800, 1.188391924, 1.162417412, 1.136845708, 1.111671090, 1.086898446, 1.062529802, 1.038595319, 1.015061140, 0.991952598,
        0.969277501, 0.947008491, 0.925164580, 0.903729379, 0.882736385, 0.862146795, 0.841972589, 0.822206259, 0.802856624, 0.783931434,
        0.765379369, 0.747242987, 0.729506135, 0.712170601, 0.695196033, 0.678622305, 0.662405372, 0.646584332, 0.631111920, 0.616003990,
        0.601231635, 0.586831212, 0.572749853, 0.559022367, 0.545615911, 0.532541931, 0.519788384, 0.507318497, 0.495189309, 0.483339012,
        0.471776038, 0.460508704, 0.449495971, 0.438794494, 0.428337216, 0.418155611, 0.408205688, 0.398518473, 0.389099985, 0.379878610,
        0.370910615, 0.362175077, 0.353650361, 0.345340610, 0.337249875, 0.329382122, 0.321687520, 0.314196140, 0.306884170, 0.299773633,
        0.292840242, 0.286083937, 0.279499054, 0.273079664, 0.266825348, 0.260732651, 0.254792511, 0.249001175, 0.243360460, 0.237860844,
        0.232501090, 0.227277011, 0.222184435, 0.217221811, 0.212381810, 0.207665712, 0.203068867, 0.198586598, 0.194217041, 0.189955309,
        0.185802370, 0.181750283, 0.177802861, 0.173952058, 0.170195624, 0.166531324, 0.162959814, 0.159475818, 0.156079918, 0.152763709,
        0.149530724, 0.146375477, 0.143298462, 0.140297130, 0.137368888, 0.134511113, 0.131721184, 0.128999487, 0.126343280, 0.123749867,
        0.121219613, 0.118749708, 0.116340466, 0.113986023, 0.111686617, 0.109442502, 0.107253917, 0.105114922, 0.103025697, 0.100983366,
        0.098991193
    }
};

/*== FUNCTION DECLARATION ====================================================*/

/**
 * @param[in] adv voltage from adc of temperature
 * @return temperature in celius. (-40 ~ 150)
 */
static int16_t __calculate(float adv);

/*== FUNCTION DEFINITION =====================================================*/

int16_t __calculate(float adv)
{
    float temperature;
    float diff, diff2;

    uint16_t i;
    temperature = TEMP_TABLE[TEMP_IDX][0];  // Minimum
    // Compare Measure Real Temp V to R-T Table
    for (i = 0; i < TEMP_TBL_CNT; i++)
    {
        if (TEMP_TABLE[TEMP_AD_IDX][i] < adv)
        {
            break;
        }
        temperature += 1.0f; // 1도씩 올라감.
    }

    if (i == 0)
    {
        return (int16_t)TEMP_TABLE[TEMP_IDX][0] * 100;
    }
    else if (i >= TEMP_TBL_CNT)
    {
        return (int16_t)TEMP_TABLE[TEMP_IDX][TEMP_TBL_CNT - 1] * 100;
    }

    // 소수점 첫째자리까지 계산 한다.
    // Current Temp Table 1Step Down
    // Current Temp - 1 Step Down Temp
    diff = TEMP_TABLE[TEMP_AD_IDX][i-1] - TEMP_TABLE[TEMP_AD_IDX][i];
    diff2 = TEMP_TABLE[TEMP_AD_IDX][i-1] - adv;
    diff = diff2 / diff;
    temperature += diff- 1;

    // scale factor is 10e-2 i.e. (1/100)
    return (int16_t)(temperature * 100);
}

void GET_EXT_TEMPERATURE(void)
{
    FET_TEMP.AVG_TEMP_BUF += EXT_TEMP_ADC_CH10;
    FET_TEMP.AVG_CHK_CNT++;

    if (TEMP_AVG_CNT == FET_TEMP.AVG_CHK_CNT)
    {
        float avgFetTemp;
        FET_TEMP.AVG_CHK_CNT = 0;
        FET_TEMP.AVG_TEMP_BUF = (FET_TEMP.AVG_TEMP_BUF / TEMP_AVG_CNT);

        // To need change real current..
        avgFetTemp = 3.3 * FET_TEMP.AVG_TEMP_BUF / 4096;    // copy
        FET_TEMP.AVG_TEMP_BUF = 0;                          // reset
        FET_TEMP.REAL_TEMP_VALUE = __calculate(avgFetTemp);
    }
#if 1
    BD_TEMP.AVG_TEMP_BUF += EXT_TEMP_ADC_CH11;
    BD_TEMP.AVG_CHK_CNT++;
    if (TEMP_AVG_CNT == BD_TEMP.AVG_CHK_CNT)
    {
        float avgBdTemp;
        BD_TEMP.AVG_CHK_CNT = 0;
        BD_TEMP.AVG_TEMP_BUF = (BD_TEMP.AVG_TEMP_BUF / TEMP_AVG_CNT);

        // To need change real current..
        avgBdTemp = 3.3 * BD_TEMP.AVG_TEMP_BUF / 4096;      // copy
        BD_TEMP.AVG_TEMP_BUF = 0;                           // reset
        BD_TEMP.REAL_TEMP_VALUE = __calculate(avgBdTemp);
    }
#else
#endif

}



